name: Deploy
on:
  push:
    branches:
      - master

jobs:
  backend:
    name: Backend
    runs-on: [self-hosted, Linux, ARM64]

    defaults:
      run:
        working-directory: backend

    env:
      KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}

    steps:
      - uses: actions/checkout@main

      - name: Setup kube config
        run: |
          mkdir $HOME/.kube
          touch $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          echo "$KUBE_CONFIG" > $HOME/.kube/config

      - name: Docker
        run: |    
          docker login registry.fiftyseven.media --username ${{ secrets.BASIC_AUTH_USERNAME }} --password ${{ secrets.BASIC_AUTH_PASSWORD }}

          CACHE_IMAGE=registry.fiftyseven.media/spendable-api:$(sha256sum mix.exs mix.lock config/config.exs config/prod.exs | sha256sum  | awk '{ print $1 }')
          LATEST_IMAGE=registry.fiftyseven.media/spendable-api:latest

          docker pull $CACHE_IMAGE || true
          docker pull $LATEST_IMAGE || true

          docker build --target build --cache-from $CACHE_IMAGE -t $CACHE_IMAGE -f .devops/Dockerfile .
          docker build \
          --cache-from $CACHE_IMAGE \
          --cache-from $LATEST_IMAGE \
          -t $LATEST_IMAGE \
          -t registry.fiftyseven.media/spendable-api:${GITHUB_SHA} \
          -f .devops/Dockerfile .

          docker push registry.fiftyseven.media/spendable-api

      - name: Setup Helm
        run: |
          helm plugin install https://github.com/chartmuseum/helm-push.git
          helm repo add cloud-57 https://helm.fiftyseven.media --username ${{ secrets.BASIC_AUTH_USERNAME }} --password ${{ secrets.BASIC_AUTH_PASSWORD }}
          helm repo update

      - name: Rollout Deploy
        run: |
          helm upgrade --install spendable cloud-57/cloud-57 \
          -f .devops/helm/values.yaml \
          --version v1.0.2 \
          --set image.repository=registry.fiftyseven.media/spendable-api \
          --set image.tag=${GITHUB_SHA} \
          -n backend
          kubectl rollout status --watch deployment spendable -n backend
